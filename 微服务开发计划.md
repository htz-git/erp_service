# 基于现有数据库表的微服务开发计划

## 一、现状与参考

### 已完成服务（参考模板）
- **erp-list-user-service**：用户、登录、多租户（zid）
- **erp-list-seller-service**：店铺 CRUD，实体/SellerDTO/SellerQueryDTO/Mapper/Service/Controller 完整

### 开发规范（以 seller-service 为准）
- **Entity**：对应表结构，`@TableName`、`@TableId(type=IdType.AUTO)`、`@TableLogic`（有 deleted 时）
- **DTO**：创建/更新用 DTO（如 SellerDTO），查询分页用 QueryDTO（pageNum/pageSize、zid/sid 等）
- **Mapper**：`extends BaseMapper<Entity>`，`@Mapper`
- **Service**：接口 + Impl，分页用 `Page<T>`，多租户用 `UserContext.getZid()/getSid()`
- **Controller**：`Result<T>` 统一返回，`@RequestMapping` 与网关路由一致（如 `/sellers`）

### 多租户规则
- 带 **zid/sid** 的表：查询时默认用 `UserContext.getZid()`、可选 `UserContext.getSid()` 过滤
- 不带 zid/sid 的表：如 promotion 的 promotion、coupon（全局配置），按需加 zid 或保持全局

---

## 二、各服务与表结构对照

| 服务 | 数据库 | 主表（需 CRUD） | 从表/辅助表 | 说明 |
|------|--------|-----------------|-------------|------|
| order | erp_list_order | order, order_item | order_status_log | zid/sid 过滤；可调 user、promotion |
| payment | erp_list_payment | payment | payment_method, payment_flow | zid/sid；可调 order |
| promotion | erp_list_promotion | promotion, coupon | user_coupon, promotion_rule | 无 zid/sid，可加 |
| purchase | erp_list_purchase | supplier, purchase_order, purchase_item | purchase_status_log | zid/sid：purchase_order/item |
| refund | erp_list_refund | refund_application | refund_record, refund_reason | zid/sid；可调 order、payment |
| replenishment | erp_list_replenishment | replenishment_order, replenishment_item | inventory_alert, replenishment_plan | zid/sid：order/item |

---

## 三、开发顺序与依赖

1. **促销服务 promotion**（无下游依赖）  
   - 实体：Promotion, Coupon, UserCoupon, PromotionRule  
   - 接口：促销 CRUD、优惠券 CRUD、分页查询（先做 promotion、coupon 主 CRUD）

2. **订单服务 order**（依赖 user、seller、可选 promotion）  
   - 实体：Order, OrderItem, OrderStatusLog  
   - 接口：订单 CRUD、订单明细、按 zid/sid 分页  
   - Feign：UserClient、SellerClient（可选 PromotionClient）

3. **支付服务 payment**（依赖 order）  
   - 实体：Payment, PaymentMethod, PaymentFlow  
   - 接口：支付记录 CRUD、支付方式列表  
   - Feign：OrderClient

4. **采购服务 purchase**（无下游依赖）  
   - 实体：Supplier, PurchaseOrder, PurchaseItem, PurchaseStatusLog  
   - 接口：供应商 CRUD、采购单 CRUD、明细、zid/sid 分页

5. **退款服务 refund**（依赖 order、payment）  
   - 实体：RefundApplication, RefundRecord, RefundReason  
   - 接口：退款申请 CRUD、退款原因列表  
   - Feign：OrderClient, PaymentClient

6. **补货服务 replenishment**（无下游依赖）  
   - 实体：ReplenishmentOrder, ReplenishmentItem, InventoryAlert, ReplenishmentPlan  
   - 接口：补货单 CRUD、补货明细、zid/sid 分页

---

## 四、各服务需补齐内容

### 1. 促销服务（erp-list-promotion-service）
- [ ] Entity：Promotion, Coupon, UserCoupon, PromotionRule
- [ ] DTO：PromotionDTO, PromotionQueryDTO, CouponDTO, CouponQueryDTO
- [ ] Mapper：PromotionMapper, CouponMapper, UserCouponMapper, PromotionRuleMapper
- [ ] Service：PromotionService, CouponService（及 Impl）
- [ ] Controller：PromotionController（/promotions）, CouponController（/coupons，与网关 /api/coupons 对应）

### 2. 订单服务（erp-list-order-service）
- [ ] Entity：Order, OrderItem, OrderStatusLog
- [ ] DTO：OrderDTO, OrderQueryDTO, OrderItemDTO
- [ ] Mapper：OrderMapper, OrderItemMapper, OrderStatusLogMapper
- [ ] Service：OrderService（含 zid/sid 过滤）
- [ ] Controller：OrderController（/orders）
- [ ] Feign：UserClient, SellerClient（在 erp-list-api 中）

### 3. 支付服务（erp-list-payment-service）
- [ ] Entity：Payment, PaymentMethod, PaymentFlow
- [ ] DTO：PaymentDTO, PaymentQueryDTO
- [ ] Mapper：PaymentMapper, PaymentMethodMapper, PaymentFlowMapper
- [ ] Service：PaymentService, PaymentMethodService
- [ ] Controller：PaymentController（/payments）
- [ ] Feign：OrderClient

### 4. 采购服务（erp-list-purchase-service）
- [ ] Entity：Supplier, PurchaseOrder, PurchaseItem, PurchaseStatusLog
- [ ] DTO：SupplierDTO, PurchaseOrderDTO, PurchaseOrderQueryDTO
- [ ] Mapper：SupplierMapper, PurchaseOrderMapper, PurchaseItemMapper, PurchaseStatusLogMapper
- [ ] Service：SupplierService, PurchaseOrderService（zid/sid）
- [ ] Controller：SupplierController, PurchaseOrderController（/purchases）

### 5. 退款服务（erp-list-refund-service）
- [ ] Entity：RefundApplication, RefundRecord, RefundReason
- [ ] DTO：RefundApplicationDTO, RefundApplicationQueryDTO
- [ ] Mapper：RefundApplicationMapper, RefundRecordMapper, RefundReasonMapper
- [ ] Service：RefundApplicationService, RefundReasonService
- [ ] Controller：RefundController（/refunds）
- [ ] Feign：OrderClient, PaymentClient

### 6. 补货服务（erp-list-replenishment-service）
- [ ] Entity：ReplenishmentOrder, ReplenishmentItem, InventoryAlert, ReplenishmentPlan
- [ ] DTO：ReplenishmentOrderDTO, ReplenishmentOrderQueryDTO
- [ ] Mapper：ReplenishmentOrderMapper, ReplenishmentItemMapper 等
- [ ] Service：ReplenishmentOrderService（zid/sid）
- [ ] Controller：ReplenishmentController（/replenishments）

---

## 五、公共约定

- **分页**：QueryDTO 统一 `pageNum=1`, `pageSize=10`，Controller 返回 `Result<Page<T>>`。
- **网关路径**：/api/orders、/api/payments、/api/promotions、/api/coupons、/api/purchases、/api/refunds、/api/replenishments，各服务内 Controller 使用 /orders、/payments 等（网关会 strip 前缀或按规则转发）。
- **Feign**：在 erp-list-api 中定义 *Client 接口，各服务按需引入 api 并 `@EnableFeignClients`。
- **数据库**：各服务 application.yaml 中配置对应数据库（与 sql 脚本一致）。

---

## 六、执行顺序建议

1. 编写本计划并评审。  
2. 实现 **促销服务**（promotion + coupon 主 CRUD）。  
3. 实现 **采购服务**（supplier + purchase_order 主 CRUD，zid/sid）。  
4. 实现 **订单服务**（order + order_item，zid/sid，后续再接 Feign）。  
5. 实现 **支付服务**（payment + payment_method）。  
6. 实现 **退款服务**（refund_application + refund_reason）。  
7. 实现 **补货服务**（replenishment_order + replenishment_item）。  
8. 在 erp-list-api 中补充 Feign Client，并在各服务中按需启用。

以上为基于现有数据库表开发其余微服务功能的完整计划，可按顺序“分析并修改”各服务。
