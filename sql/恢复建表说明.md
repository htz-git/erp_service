# 数据库已存在时如何恢复表结构 + Nacos 配置恢复

---

## 一、ERP 表结构恢复（建表 SQL）

### 说明

- 项目内脚本：`建表汇总.sql`（本地路径 `d:\erp_list\sql\建表汇总.sql`）。
- 服务器上已有：**`/opt/erp_list/sql/erp_create_tables.sql`**（与建表汇总内容一致即可）。
- 脚本使用 **CREATE DATABASE IF NOT EXISTS** 和 **CREATE TABLE IF NOT EXISTS**：库/表已存在则跳过，不存在则创建，不会清空已有数据。

### 在服务器上执行（推荐）

```bash
# 使用服务器已有路径
docker exec -i mysql-nacos mysql -uroot -proot < /opt/erp_list/sql/erp_create_tables.sql
```

### 若需从本机上传后再执行

```bash
# 本机上传（示例）
scp d:\erp_list\sql\建表汇总.sql root@你的服务器IP:/opt/erp_list/sql/erp_create_tables.sql

# 服务器上执行
docker exec -i mysql-nacos mysql -uroot -proot < /opt/erp_list/sql/erp_create_tables.sql
```

### 执行后检查

```bash
docker exec mysql-nacos mysql -uroot -proot -e "
SELECT table_schema, COUNT(*) AS cnt
FROM information_schema.tables
WHERE table_schema LIKE 'erp_list%'
GROUP BY table_schema
ORDER BY table_schema;
"
```

### 关于初始数据

- **permission 表**：脚本里有 `INSERT ... ON DUPLICATE KEY UPDATE`，重复执行不会报错。
- **refund_reason 表**：普通 `INSERT`，若已有数据可能报重复键，可忽略或只执行一次。
- 其它业务数据需自行从备份恢复或重新录入；本脚本只恢复**表结构**及上述少量初始数据。

---

## 二、Nacos 配置恢复

Nacos 使用 MySQL 时，配置存在 **`nacos_config`** 库中，主要表：`config_info`（当前配置）、`his_config_info`（历史）、`config_info_beta`（Beta）等。

### Nacos 初始化 SQL 路径与恢复命令

**说明**：项目里没有自带 nacos 的建表 SQL，该文件在 **Nacos 官方镜像** 或 **GitHub 仓库** 里。

| 来源 | 路径或地址 |
|------|------------|
| Nacos 镜像内（常见） | `/home/nacos/conf/mysql-schema.sql` 或 `/home/nacos/conf/nacos-mysql.sql` |
| GitHub 官方（按版本） | https://github.com/alibaba/nacos/blob/2.3.2/distribution/conf/mysql-schema.sql |

**1）在服务器上查看 Nacos 镜像/容器里的 SQL 路径：**

```bash
# 列出镜像内可能带 nacos/mysql 的 sql 文件（镜像名按你实际，如 nacos/nacos-server:v2.3.2）
docker run --rm --entrypoint find nacos/nacos-server:v2.3.2 /home/nacos -name "*.sql" 2>/dev/null

# 若 Nacos 容器正在运行，也可进容器查
docker exec nacos-server find /home/nacos -name "*.sql" 2>/dev/null
```

**2）从镜像中导出初始化 SQL 到宿主机（无需启动 Nacos）：**

```bash
# 导出到 /opt/nacos/mysql-schema.sql（路径可改）
docker run --rm --entrypoint cat nacos/nacos-server:v2.3.2 /home/nacos/conf/mysql-schema.sql > /opt/nacos/mysql-schema.sql
```

若该路径不存在，先执行上面 `find` 看实际文件名（可能是 `nacos-mysql.sql`），再替换路径：

```bash
docker run --rm --entrypoint cat nacos/nacos-server:v2.3.2 /home/nacos/conf/nacos-mysql.sql > /opt/nacos/mysql-schema.sql
```

**3）用导出的 SQL 初始化/恢复 nacos_config 库：**

```bash
# 先建库（若不存在）
docker exec mysql-nacos mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS nacos_config DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入表结构（会建表；若表已存在可能报错，需先备份或删库再导）
docker exec -i mysql-nacos mysql -uroot -proot nacos_config < /opt/nacos/mysql-schema.sql
```

**4）重启 Nacos 使配置生效：**

```bash
docker restart nacos-server
```

---

### 1. 有备份时：从 MySQL 备份恢复

若之前对 `nacos_config` 做过逻辑备份（mysqldump）：

```bash
# 恢复示例（备份文件为 nacos_config_backup.sql）
docker exec -i mysql-nacos mysql -uroot -proot nacos_config < /path/to/nacos_config_backup.sql
```

若整库备份里包含 nacos_config，恢复整库或只导入 nacos_config 库即可。

### 2. 无备份时：重新初始化 Nacos 表结构

若 `nacos_config` 库损坏或为空，按上文 **「Nacos 初始化 SQL 路径与恢复命令」** 执行：从镜像导出 `mysql-schema.sql` → 导入到 `nacos_config` 库 → 重启 Nacos，再在控制台或 Open API 重新添加配置。

### 3. 日常备份建议（避免再次丢失）

定期备份 `nacos_config`，便于以后恢复：

```bash
# 备份 nacos_config 库
docker exec mysql-nacos mysqldump -uroot -proot nacos_config > /opt/backup/nacos_config_$(date +%Y%m%d).sql
```

可配合 crontab 做每日备份。

### 4. 通过 Nacos 控制台导出/导入（单次迁移）

- **导出**：Nacos 控制台 → 配置管理 → 配置列表 → 可逐个导出或使用 Open API 批量导出。
- **导入**：控制台「导入配置」或调用 Open API 写入。适合配置量不大、从一台 Nacos 迁到另一台的场景。

---

## 小结

| 需求           | 操作 |
|----------------|------|
| ERP 表结构恢复 | 执行 `/opt/erp_list/sql/erp_create_tables.sql` |
| Nacos 有备份   | 用 mysqldump 备份文件恢复 `nacos_config` 库 |
| Nacos 无备份   | 用官方 mysql-schema.sql 重建表，再在控制台重新配 |
| 以后少丢配置   | 定期 mysqldump 备份 `nacos_config` |
